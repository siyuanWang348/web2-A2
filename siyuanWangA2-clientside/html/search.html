<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Search Charity Events</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="logo">Charity Events</div>
    <div class="nav-links">
      <a href="/">Home</a>
      <a href="/search" class="active">Search Events</a>
    </div>
  </nav>

  <div class="container">
    <h1>🔎 Search Events</h1>

    <form id="searchForm" class="search-form">
      <div class="form-group">
        <label>Date: <input type="date" id="date"></label>
      </div>
      <div class="form-group">
        <label>Location: <input type="text" id="location" placeholder="Enter location"></label>
      </div>
      <div class="form-group">
        <label>Category: 
          <select id="category">
            <option value="">-- All --</option>
          </select>
        </label>
      </div>
      <div class="form-buttons">
        <button type="submit" class="btn btn-search">Search</button>
        <button type="button" class="btn btn-clear" onclick="clearFilters()">Clear</button>
      </div>
    </form>

    <h2>Results</h2>
    <div id="results" class="events-grid"></div>
  </div>

  <script>
    // 加载类别列表
    fetch('http://localhost:3001/api/categories')
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById('category');
        data.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.category_id;
          option.textContent = cat.category_name;
          select.appendChild(option);
        });
      });

    // 搜索表单提交
    document.getElementById('searchForm').addEventListener('submit', e => {
      e.preventDefault();
      const date = document.getElementById('date').value;
      const location = document.getElementById('location').value;
      const category = document.getElementById('category').value;

      let url = 'http://localhost:3001/api/search?';
      const params = [];
      if (date) params.push(`date=${date}`);
      if (location) params.push(`location=${encodeURIComponent(location)}`);
      if (category) params.push(`category_id=${category}`);
      
      // 处理参数拼接，避免末尾多余的&
      url += params.join('&');

      fetch(url)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('results');
          container.innerHTML = "";
          if (data.length === 0) {
            container.innerHTML = "<p>No events found.</p>";
            return;
          }
          data.forEach(ev => {
            const div = document.createElement('div');
            div.className = "event-card";
            div.innerHTML = `
              <h3><a href="/event?event_id=${ev.event_id}">${ev.title}</a></h3>
              <p>📅 ${new Date(ev.event_date).toLocaleString()}</p>
              <p>📍 ${ev.location}</p>
              <p>🏷️ ${ev.category_name} | Org: ${ev.org_name}</p>
              <button class="btn" onclick="window.location.href='/event?event_id=${ev.event_id}'">View Details</button>
            `;
            container.appendChild(div);
          });
        });
    });

    function clearFilters() {
      document.getElementById('date').value = "";
      document.getElementById('location').value = "";
      document.getElementById('category').value = "";
      document.getElementById('results').innerHTML = "";
    }
  </script>
</body>
</html>